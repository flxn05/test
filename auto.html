<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ambient Theme Demo</title>
<style>
  /* Smooth transitions for theme changes */
  html, body {
    margin: 0;
    padding: 0;
    transition: background-color 0.8s ease, color 0.8s ease;
    font-family: sans-serif;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  /* Theme variables */
  :root {
    --bg: #ffffff;
    --fg: #111111;
  }

  [data-theme="dark"] {
    --bg: #121212;
    --fg: #e6eef6;
  }

  body {
    background-color: var(--bg);
    color: var(--fg);
    text-align: center;
  }

  /* Fade-in text for dark surroundings */
  #dark-text {
    opacity: 0;
    transition: opacity 1s ease;
    font-size: 2rem;
    margin-top: 1rem;
  }

  [data-theme="dark"] #dark-text {
    opacity: 1;
  }

  /* Toggle button */
  #theme-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    background: var(--fg);
    color: var(--bg);
    border: none;
    border-radius: 4px;
    transition: background 0.8s ease, color 0.8s ease;
  }
</style>
</head>
<body>

<h1>Ambient Theme Demo</h1>
<div id="dark-text">Dark Surrounding</div>
<button id="theme-toggle" aria-pressed="false">Toggle Theme</button>

<script>
/* Simple theme manager with smooth transitions */

(function() {
  const toggleBtn = document.getElementById('theme-toggle');
  const storageKey = 'site-theme-pref';
  const manualKey = 'site-theme-manual';

  // Helpers
  const setTheme = theme => {
    if (theme === 'dark' || theme === 'light') {
      document.documentElement.setAttribute('data-theme', theme);
    } else {
      document.documentElement.removeAttribute('data-theme');
    }
  };

  const savePref = theme => localStorage.setItem(storageKey, theme);
  const readPref = () => localStorage.getItem(storageKey);
  const setManual = yes => yes ? localStorage.setItem(manualKey, '1') : localStorage.removeItem(manualKey);
  const isManual = () => !!localStorage.getItem(manualKey);

  const systemPrefersDark = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const timeOfDayTheme = () => (new Date().getHours() >= 18 || new Date().getHours() < 6) ? 'dark' : 'light';

  // Manual toggle
  toggleBtn.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme') || (systemPrefersDark() ? 'dark' : 'light');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
    savePref(newTheme);
    setManual(true);
    toggleBtn.setAttribute('aria-pressed', newTheme === 'dark');
    toggleBtn.textContent = newTheme === 'dark' ? 'Switch to Light' : 'Switch to Dark';
  });

  // Initialize toggle UI
  const initToggle = () => {
    const pref = readPref();
    if (pref) {
      setTheme(pref);
      toggleBtn.setAttribute('aria-pressed', pref === 'dark');
      toggleBtn.textContent = pref === 'dark' ? 'Switch to Light' : 'Switch to Dark';
    } else {
      toggleBtn.setAttribute('aria-pressed', systemPrefersDark());
      toggleBtn.textContent = systemPrefersDark() ? 'Switch to Light' : 'Switch to Dark';
    }
  };

  // Camera brightness sampling
  async function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 160, height: 120 } });
      const video = document.createElement('video');
      video.autoplay = true;
      video.playsInline = true;
      video.muted = true;
      video.srcObject = stream;

      const canvas = document.createElement('canvas');
      await new Promise(resolve => {
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth || 160;
          canvas.height = video.videoHeight || 120;
          resolve();
        };
      });

      let smoothLum = null;
      const threshold = 60;

      const sample = () => {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let total = 0;
        let count = 0;
        for (let i = 0; i < img.length; i += 4*4) { // skip pixels for speed
          const lum = 0.2126*img[i] + 0.7152*img[i+1] + 0.0722*img[i+2];
          total += lum;
          count++;
        }
        const avg = total / count;
        smoothLum = smoothLum === null ? avg : 0.2*avg + 0.8*smoothLum;
        if (!isManual()) setTheme(smoothLum < threshold ? 'dark' : 'light');
        setTimeout(sample, 2000);
      };
      sample();
    } catch(e) {
      // fallback to system/time
      if (!isManual()) setTheme(systemPrefersDark() ? 'dark' : timeOfDayTheme());
    }
  }

  // Initialize
  initToggle();
  startCamera();
})();
</script>

</body>
</html>
