<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Cube Shadow</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #fff;
    transition: background-color 0.5s ease;
    perspective: 800px;
    flex-direction: column;
  }

  #start {
    padding: 16px 32px;
    font-size: 18px;
    cursor: pointer;
    border-radius: 8px;
    border: none;
    background: #0077ff;
    color: white;
    z-index: 10; /* ensure button is on top */
    position: relative;
  }

  .cube-container {
    width: 150px;
    height: 150px;
    transform-style: preserve-3d;
    position: relative;
    display: none; /* hidden until start */
  }

  .cube {
    width: 100px;
    height: 100px;
    background: #f9f9f9;
    transform: rotateX(20deg) rotateY(20deg);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    border-radius: 5px;
    transition: box-shadow 0.1s linear, transform 0.1s linear;
    margin: auto;
    position: absolute;
    top: 0; bottom: 0; left: 0; right: 0;
  }
</style>
</head>
<body>

<button id="start">Start</button>
<div class="cube-container">
  <div class="cube"></div>
</div>

<script>
const startBtn = document.getElementById('start');
const cube = document.querySelector('.cube');
const cubeContainer = document.querySelector('.cube-container');

let brightness = 1;
let xRotation = 20, yRotation = 20;

async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    const video = document.createElement('video');
    video.srcObject = stream;
    video.play();

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    function sampleBrightness() {
      if (video.videoWidth === 0) return requestAnimationFrame(sampleBrightness);
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let total = 0;
      for (let i = 0; i < frame.data.length; i += 4) {
        const r = frame.data[i];
        const g = frame.data[i+1];
        const b = frame.data[i+2];
        total += 0.2126*r + 0.7152*g + 0.0722*b;
      }
      const avg = total / (frame.data.length / 4);
      brightness = avg / 255;
      document.body.style.backgroundColor = `rgb(${Math.floor(brightness*255)},${Math.floor(brightness*255)},${Math.floor(brightness*255)})`;
      requestAnimationFrame(sampleBrightness);
    }

    video.addEventListener('loadeddata', () => sampleBrightness());
  } catch(e) {
    console.warn("Camera not accessible.");
  }
}

function initMotion() {
  function addListener() {
    window.addEventListener('deviceorientation', (event) => {
      const gamma = event.gamma || 0;
      const beta = event.beta || 0;
      xRotation = 20 + beta; 
      yRotation = 20 + gamma;
      cube.style.transform = `rotateX(${xRotation}deg) rotateY(${yRotation}deg)`;
      
      const maxOffset = 40;
      const xOffset = gamma / 90 * maxOffset; 
      const yOffset = beta / 90 * maxOffset;
      const shadowIntensity = Math.min(Math.max(brightness, 0), 1);
      const shadowColor = `rgba(0,0,0,${0.15 * shadowIntensity})`;
      cube.style.boxShadow = `${xOffset}px ${20 + yOffset}px 40px ${shadowColor}`;
    });
  }

  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission()
      .then(response => {
        if (response === 'granted') addListener();
      })
      .catch(console.error);
  } else {
    addListener();
  }
}

async function enterFullscreenAndLock() {
  const elem = document.documentElement;
  if (elem.requestFullscreen) await elem.requestFullscreen();
  if (screen.orientation && screen.orientation.lock) {
    try { await screen.orientation.lock('portrait'); } catch(e) {}
  }
}

startBtn.addEventListener('click', async () => {
  startBtn.style.display = 'none';
  cubeContainer.style.display = 'block';
  await enterFullscreenAndLock();
  initCamera();
  initMotion();
});
</script>

</body>
</html>
